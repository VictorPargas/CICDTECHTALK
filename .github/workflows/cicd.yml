name: CI/CD Worker Service

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SERVICE_NAME: WorkerServiceTest
  DOTNET_VERSION: "8.0.x"
  PROJECT_PATH: "./WorkerServiceTest/WorkerServiceTest.csproj"
  PUBLISH_PATH: "./publish"
  SERVICE_PATH: "C:\\Services\\WorkerServiceTest"

jobs:
  build-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Verificar .NET instalado
        run: |
          Write-Host "Verificando instalacao do .NET..."
          dotnet --version
          dotnet --list-sdks
          Write-Host ".NET esta disponivel!"

      - name: Restaurar dependencias
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration Release --no-restore

      - name: Test (se houver testes)
        run: dotnet test "${{ env.PROJECT_PATH }}" --configuration Release --no-build --verbosity normal
        continue-on-error: true

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Verificar .NET instalado
        run: |
          Write-Host "Verificando instalacao do .NET..."
          dotnet --version

      - name: Publish aplicacao
        run: |
          dotnet publish "${{ env.PROJECT_PATH }}" `
            --configuration Release `
            --output ${{ env.PUBLISH_PATH }} `
            --runtime win-x64 `
            --self-contained false

      - name: Verificar se servico existe
        id: check-service
        run: |
          $service = Get-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
          if ($service) {
            Write-Host "Servico '${{ env.SERVICE_NAME }}' encontrado!"
            Write-Host "Status atual: $($service.Status)"
            echo "SERVICE_EXISTS=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Servico '${{ env.SERVICE_NAME }}' nao existe"
            Write-Host "Sera criado automaticamente..."
            echo "SERVICE_EXISTS=false" >> $env:GITHUB_OUTPUT
          }

      - name: Parar servico (se existir)
        if: steps.check-service.outputs.SERVICE_EXISTS == 'true'
        run: |
          Write-Host "Parando servico ${{ env.SERVICE_NAME }}..."
          Stop-Service -Name "${{ env.SERVICE_NAME }}" -Force
          Start-Sleep -Seconds 5
          Write-Host "Servico parado!"

      - name: Criar/Verificar diretorio de servico
        run: |
          $destPath = "${{ env.SERVICE_PATH }}"

          if (-not (Test-Path $destPath)) {
            Write-Host "Criando diretorio: $destPath"
            New-Item -ItemType Directory -Path $destPath -Force | Out-Null
            Write-Host "Diretorio criado!"
          } else {
            Write-Host "Diretorio ja existe: $destPath"
          }

      - name: Copiar arquivos para diretorio de producao
        run: |
          $destPath = "${{ env.SERVICE_PATH }}"

          Write-Host "Copiando arquivos para $destPath..."
          Copy-Item -Path "${{ env.PUBLISH_PATH }}\*" -Destination $destPath -Recurse -Force
          Write-Host "Arquivos copiados com sucesso!"

          Write-Host ""
          Write-Host "Verificando arquivos copiados:"
          Get-ChildItem -Path $destPath | Select-Object Name, Length, LastWriteTime | Format-Table

      - name: Verificar executavel
        run: |
          $exePath = "${{ env.SERVICE_PATH }}\WorkerServiceTest.exe"

          if (Test-Path $exePath) {
            Write-Host "Executavel encontrado: $exePath"
            $file = Get-Item $exePath
            Write-Host "Tamanho: $($file.Length) bytes"
            Write-Host "Modificado em: $($file.LastWriteTime)"
          } else {
            Write-Host "ERRO: Executavel nao encontrado em $exePath"
            exit 1
          }

      - name: Criar servico Windows (se nao existir)
        if: steps.check-service.outputs.SERVICE_EXISTS == 'false'
        run: |
          $serviceName = "${{ env.SERVICE_NAME }}"
          $exePath = "${{ env.SERVICE_PATH }}\WorkerServiceTest.exe"

          Write-Host "Criando servico Windows..."
          Write-Host "Nome: $serviceName"
          Write-Host "Executavel: $exePath"

          try {
            $service = New-Service `
              -Name $serviceName `
              -BinaryPathName $exePath `
              -DisplayName "Worker Service Test" `
              -Description "Worker Service .NET 8 com CI/CD automatico" `
              -StartupType Automatic `
              -ErrorAction Stop
            
            Write-Host "Servico criado com sucesso!"
            
            Start-Sleep -Seconds 2
            
            $newService = Get-Service -Name $serviceName
            Write-Host "Confirmacao: Servico '$($newService.DisplayName)' criado"
            Write-Host "Status inicial: $($newService.Status)"
          } catch {
            Write-Host "ERRO ao criar o servico:"
            Write-Host $_.Exception.Message
            Write-Host ""
            Write-Host "Verifique se o runner tem permissoes de administrador"
            exit 1
          }

      - name: Iniciar servico
        run: |
          Write-Host "Iniciando servico ${{ env.SERVICE_NAME }}..."

          try {
            Start-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction Stop
            Start-Sleep -Seconds 5

            $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
            Write-Host "Status do servico: $($service.Status)"

            if ($service.Status -eq 'Running') {
              Write-Host "Servico iniciado com sucesso!"
            } else {
              Write-Host "Servico nao esta rodando. Status: $($service.Status)"
              Write-Host "Tentando iniciar novamente..."
              Start-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction Stop
              Start-Sleep -Seconds 3
              
              $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
              if ($service.Status -eq 'Running') {
                Write-Host "Servico iniciado na segunda tentativa!"
              } else {
                Write-Host "ERRO: Nao foi possivel iniciar o servico"
                Write-Host "Status final: $($service.Status)"
                throw "Servico nao iniciou"
              }
            }
          } catch {
            Write-Host ""
            Write-Host "ERRO ao iniciar o servico:"
            Write-Host $_.Exception.Message
            Write-Host ""
            Write-Host "Verifique os logs do Event Viewer para mais detalhes:"
            Write-Host "Get-EventLog -LogName Application -Source WorkerServiceTest -Newest 10"
            Write-Host ""
            
            Write-Host "Tentando obter ultimos logs do Event Viewer..."
            Get-EventLog -LogName Application -Newest 10 -ErrorAction SilentlyContinue | 
              Where-Object { $_.Source -like "*Worker*" -or $_.Message -like "*WorkerServiceTest*" } |
              Format-Table TimeGenerated, EntryType, Source, Message -AutoSize
            
            exit 1
          }

      - name: Verificar logs do Event Viewer
        run: |
          Write-Host ""
          Write-Host "Ultimos 10 eventos do servico:"
          Get-EventLog -LogName Application -Source "${{ env.SERVICE_NAME }}" -Newest 10 -ErrorAction SilentlyContinue | 
            Format-Table TimeGenerated, EntryType, Message -AutoSize
        continue-on-error: true

      - name: Resumo do Deploy
        run: |
          Write-Host ""
          Write-Host "========================================"
          Write-Host "   DEPLOY CONCLUIDO COM SUCESSO!"
          Write-Host "========================================"

          $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
          Write-Host "Servico: $($service.DisplayName)"
          Write-Host "Status: $($service.Status)"
          Write-Host "Startup: $($service.StartType)"
          Write-Host "Localizacao: ${{ env.SERVICE_PATH }}"

          $exePath = "${{ env.SERVICE_PATH }}\WorkerServiceTest.exe"
          if (Test-Path $exePath) {
            $file = Get-Item $exePath
            Write-Host "Executavel: $($file.Length) bytes"
          }

          Write-Host "========================================"
