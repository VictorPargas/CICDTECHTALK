name: CI/CD Worker Service

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SERVICE_NAME: WorkerServiceTest
  DOTNET_VERSION: "8.0.x"
  PROJECT_PATH: "./WorkerServiceTest/WorkerServiceTest.csproj"
  PUBLISH_PATH: "./publish"
  SERVICE_PATH: "C:\\Services\\WorkerServiceTest"

jobs:
  build-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar .NET instalado
        run: |
          Write-Host "Verificando instala√ß√£o do .NET..."
          dotnet --version
          dotnet --list-sdks
          Write-Host "‚úÖ .NET est√° dispon√≠vel!"

      - name: Restaurar depend√™ncias
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration Release --no-restore

      - name: Test (se houver testes)
        run: dotnet test "${{ env.PROJECT_PATH }}" --configuration Release --no-build --verbosity normal
        continue-on-error: true

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Verificar .NET instalado
        run: |
          Write-Host "Verificando instala√ß√£o do .NET..."
          dotnet --version

      - name: Publish aplica√ß√£o
        run: |
          dotnet publish "${{ env.PROJECT_PATH }}" `
            --configuration Release `
            --output ${{ env.PUBLISH_PATH }} `
            --runtime win-x64 `
            --self-contained false

      - name: Verificar/Criar diret√≥rio de servi√ßo
        run: |
          $destPath = "${{ env.SERVICE_PATH }}"

          if (-not (Test-Path $destPath)) {
            Write-Host "üìÅ Criando diret√≥rio: $destPath"
            New-Item -ItemType Directory -Path $destPath -Force | Out-Null
            Write-Host "‚úÖ Diret√≥rio criado!"
          } else {
            Write-Host "‚úÖ Diret√≥rio j√° existe: $destPath"
          }

      - name: Verificar se servi√ßo existe
        id: check-service
        run: |
          $service = Get-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
          if ($service) {
            Write-Host "‚úÖ Servi√ßo '${{ env.SERVICE_NAME }}' encontrado!"
            Write-Host "Status atual: $($service.Status)"
            echo "SERVICE_EXISTS=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "‚ö†Ô∏è Servi√ßo '${{ env.SERVICE_NAME }}' n√£o existe"
            Write-Host "üìù Ser√° criado automaticamente..."
            echo "SERVICE_EXISTS=false" >> $env:GITHUB_OUTPUT
          }

      - name: Parar servi√ßo (se existir)
        if: steps.check-service.outputs.SERVICE_EXISTS == 'true'
        run: |
          Write-Host "‚èπÔ∏è Parando servi√ßo ${{ env.SERVICE_NAME }}..."
          Stop-Service -Name "${{ env.SERVICE_NAME }}" -Force
          Start-Sleep -Seconds 5
          Write-Host "‚úÖ Servi√ßo parado!"

      - name: Copiar arquivos para diret√≥rio de produ√ß√£o
        run: |
          $destPath = "${{ env.SERVICE_PATH }}"

          Write-Host "üì¶ Copiando arquivos para $destPath..."
          Copy-Item -Path "${{ env.PUBLISH_PATH }}\*" -Destination $destPath -Recurse -Force
          Write-Host "‚úÖ Arquivos copiados com sucesso!"

      - name: Criar servi√ßo Windows (se n√£o existir)
        if: steps.check-service.outputs.SERVICE_EXISTS == 'false'
        run: |
          $serviceName = "${{ env.SERVICE_NAME }}"
          $exePath = "${{ env.SERVICE_PATH }}\WorkerServiceTest.exe"

          Write-Host "üîß Criando servi√ßo Windows..."
          Write-Host "Nome: $serviceName"
          Write-Host "Execut√°vel: $exePath"

          try {
            $service = New-Service `
              -Name $serviceName `
              -BinaryPathName $exePath `
              -DisplayName "Worker Service Test" `
              -Description "Worker Service .NET 8 com CI/CD autom√°tico" `
              -StartupType Automatic `
              -ErrorAction Stop
            
            Write-Host "‚úÖ Servi√ßo criado com sucesso!"
          } catch {
            Write-Host "‚ùå Erro ao criar o servi√ßo:" -ForegroundColor Red
            Write-Host $_.Exception.Message -ForegroundColor Red
            Write-Host ""
            Write-Host "Verifique se o runner tem permiss√µes de administrador" -ForegroundColor Yellow
            exit 1
          }

      - name: Iniciar servi√ßo
        run: |
          Write-Host "‚ñ∂Ô∏è Iniciando servi√ßo ${{ env.SERVICE_NAME }}..."
          Start-Service -Name "${{ env.SERVICE_NAME }}"
          Start-Sleep -Seconds 5

          $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
          Write-Host "Status do servi√ßo: $($service.Status)"

          if ($service.Status -eq 'Running') {
            Write-Host "‚úÖ Servi√ßo iniciado com sucesso!" -ForegroundColor Green
          } else {
            Write-Host "‚ö†Ô∏è Servi√ßo n√£o est√° rodando. Status: $($service.Status)" -ForegroundColor Yellow
            Write-Host "Tentando iniciar novamente..."
            Start-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 3
            
            $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
            if ($service.Status -eq 'Running') {
              Write-Host "‚úÖ Servi√ßo iniciado na segunda tentativa!"
            } else {
              Write-Host "‚ùå Erro ao iniciar o servi√ßo"
              Write-Host "Verifique os logs do Event Viewer para mais detalhes"
              exit 1
            }
          }

      - name: Verificar logs do Event Viewer
        run: |
          Write-Host "`nüìã √öltimos 5 eventos do servi√ßo:"
          Get-EventLog -LogName Application -Source "${{ env.SERVICE_NAME }}" -Newest 5 -ErrorAction SilentlyContinue | 
            Format-Table TimeGenerated, EntryType, Message -AutoSize
        continue-on-error: true

      - name: Resumo do Deploy
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "   DEPLOY CONCLU√çDO COM SUCESSO!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan

          $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
          Write-Host "Servi√ßo: $($service.DisplayName)" -ForegroundColor White
          Write-Host "Status: $($service.Status)" -ForegroundColor Green
          Write-Host "Startup: $($service.StartType)" -ForegroundColor White
          Write-Host "Localiza√ß√£o: ${{ env.SERVICE_PATH }}" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Cyan
