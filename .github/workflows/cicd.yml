name: CI/CD Worker Service

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SERVICE_NAME: WorkerServiceTest
  DOTNET_VERSION: "8.0.x"
  PROJECT_PATH: "./WorkerServiceTest/WorkerServiceTest.csproj"
  PUBLISH_PATH: "./publish"
  SERVICE_PATH: "C:\\Services\\WorkerServiceTest"

jobs:
  build-and-test:
    runs-on: self-hosted

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Verificar .NET instalado
        run: |
          Write-Host "Verificando instalação do .NET..."
          dotnet --version
          dotnet --list-sdks
          Write-Host ".NET está disponível!"

      - name: Restaurar dependências
        run: dotnet restore "${{ env.PROJECT_PATH }}"

      - name: Build
        run: dotnet build "${{ env.PROJECT_PATH }}" --configuration Release --no-restore

      - name: Test (se houver testes)
        run: dotnet test "${{ env.PROJECT_PATH }}" --configuration Release --no-build --verbosity normal
        continue-on-error: true

  deploy:
    needs: build-and-test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Verificar .NET instalado
        run: |
          Write-Host "Verificando instalação do .NET..."
          dotnet --version

      - name: Publish aplicação
        run: |
          dotnet publish "${{ env.PROJECT_PATH }}" `
            --configuration Release `
            --output ${{ env.PUBLISH_PATH }} `
            --runtime win-x64 `
            --self-contained false

      - name: Verificar/Criar diretório de serviço
        run: |
          $destPath = "${{ env.SERVICE_PATH }}"

          if (-not (Test-Path $destPath)) {
            Write-Host "Criando diretório: $destPath"
            New-Item -ItemType Directory -Path $destPath -Force | Out-Null
            Write-Host "Diretório criado!"
          } else {
            Write-Host "Diretório já existe: $destPath"
          }

      - name: Verificar se serviço existe
        id: check-service
        run: |
          $service = Get-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
          if ($service) {
            Write-Host "Serviço '${{ env.SERVICE_NAME }}' encontrado!"
            Write-Host "Status atual: $($service.Status)"
            echo "SERVICE_EXISTS=true" >> $env:GITHUB_OUTPUT
          } else {
            Write-Host "Serviço '${{ env.SERVICE_NAME }}' não existe"
            Write-Host "Será criado automaticamente..."
            echo "SERVICE_EXISTS=false" >> $env:GITHUB_OUTPUT
          }

      - name: Parar serviço (se existir)
        if: steps.check-service.outputs.SERVICE_EXISTS == 'true'
        run: |
          Write-Host "Parando serviço ${{ env.SERVICE_NAME }}..."
          Stop-Service -Name "${{ env.SERVICE_NAME }}" -Force
          Start-Sleep -Seconds 5
          Write-Host "Serviço parado!"

      - name: Copiar arquivos para diretório de produção
        run: |
          $destPath = "${{ env.SERVICE_PATH }}"

          Write-Host "Copiando arquivos para $destPath..."
          Copy-Item -Path "${{ env.PUBLISH_PATH }}\*" -Destination $destPath -Recurse -Force
          Write-Host "Arquivos copiados com sucesso!"

      - name: Criar serviço Windows (se não existir)
        if: steps.check-service.outputs.SERVICE_EXISTS == 'false'
        run: |
          $serviceName = "${{ env.SERVICE_NAME }}"
          $exePath = "${{ env.SERVICE_PATH }}\WorkerServiceTest.exe"

          Write-Host "Criando serviço Windows..."
          Write-Host "Nome: $serviceName"
          Write-Host "Executável: $exePath"

          try {
            $service = New-Service `
              -Name $serviceName `
              -BinaryPathName $exePath `
              -DisplayName "Worker Service Test" `
              -Description "Worker Service .NET 8 com CI/CD automático" `
              -StartupType Automatic `
              -ErrorAction Stop
            
            Write-Host "Serviço criado com sucesso!"
          } catch {
            Write-Host "Erro ao criar o serviço:" -ForegroundColor Red
            Write-Host $_.Exception.Message -ForegroundColor Red
            Write-Host ""
            Write-Host "Verifique se o runner tem permissões de administrador" -ForegroundColor Yellow
            exit 1
          }

      - name: Iniciar serviço
        run: |
          Write-Host "Iniciando serviço ${{ env.SERVICE_NAME }}..."
          Start-Service -Name "${{ env.SERVICE_NAME }}"
          Start-Sleep -Seconds 5

          $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
          Write-Host "Status do serviço: $($service.Status)"

          if ($service.Status -eq 'Running') {
            Write-Host "Serviço iniciado com sucesso!" -ForegroundColor Green
          } else {
            Write-Host "Serviço não está rodando. Status: $($service.Status)" -ForegroundColor Yellow
            Write-Host "Tentando iniciar novamente..."
            Start-Service -Name "${{ env.SERVICE_NAME }}" -ErrorAction SilentlyContinue
            Start-Sleep -Seconds 3
            
            $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
            if ($service.Status -eq 'Running') {
              Write-Host "Serviço iniciado na segunda tentativa!"
            } else {
              Write-Host "Erro ao iniciar o serviço"
              Write-Host "Verifique os logs do Event Viewer para mais detalhes"
              exit 1
            }
          }

      - name: Verificar logs do Event Viewer
        run: |
          Write-Host "`Últimos 5 eventos do serviço:"
          Get-EventLog -LogName Application -Source "${{ env.SERVICE_NAME }}" -Newest 5 -ErrorAction SilentlyContinue | 
            Format-Table TimeGenerated, EntryType, Message -AutoSize
        continue-on-error: true

      - name: Resumo do Deploy
        run: |
          Write-Host "`n========================================" -ForegroundColor Cyan
          Write-Host "   DEPLOY CONCLUÍDO COM SUCESSO!" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Cyan

          $service = Get-Service -Name "${{ env.SERVICE_NAME }}"
          Write-Host "Serviço: $($service.DisplayName)" -ForegroundColor White
          Write-Host "Status: $($service.Status)" -ForegroundColor Green
          Write-Host "Startup: $($service.StartType)" -ForegroundColor White
          Write-Host "Localização: ${{ env.SERVICE_PATH }}" -ForegroundColor White
          Write-Host "========================================" -ForegroundColor Cyan
